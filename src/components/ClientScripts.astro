---
// Client-side scripts for image optimization and interactions
---

<!-- Google Analytics -->
<script is:inline>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // Lazy load Google Analytics
  const loadGA = () => {
    const script = document.createElement('script');
    script.src = 'https://www.googletagmanager.com/gtag/js?id=G-DT01FBW30E';
    script.async = true;
    document.head.appendChild(script);

    gtag('js', new Date());
    gtag('config', 'G-DT01FBW30E');
  };

  // Wait for user interaction or delay
  const triggerGA = () => {
    window.removeEventListener('scroll', triggerGA);
    window.removeEventListener('mousemove', triggerGA);
    window.removeEventListener('touchstart', triggerGA);
    loadGA();
  };

  window.addEventListener('scroll', triggerGA, { once: true });
  window.addEventListener('mousemove', triggerGA, { once: true });
  window.addEventListener('touchstart', triggerGA, { once: true });
  setTimeout(() => {
    // Fallback if no interaction after 5s
    if (!window.dataLayer.length) loadGA();
  }, 5000);
</script>

<script is:inline>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(
        (registration) => {
          console.log('SW registered: ', registration);
        },
        (registrationError) => {
          console.log('SW registration failed: ', registrationError);
        }
      );
    });
  }
</script>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  document.addEventListener('DOMContentLoaded', () => {
    // Open external links in a new tab
    Array.from(document.links).forEach((link) => {
      if (link.hostname !== window.location.hostname) {
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
      }
    });

    // Lazy load images after the first two
    const images = document.querySelectorAll('#write img');
    images.forEach((img, index) => {
      if (index > 1) {
        img.setAttribute('loading', 'lazy');
        img.setAttribute('decoding', 'async');
      }
    });

    // Initialize PhotoSwipe
    const lightbox = new PhotoSwipeLightbox({
      gallery: '#write',
      children: 'img',
      pswpModule: () => import('photoswipe'),
      imageClickAction: 'zoom',
      tapAction: 'zoom',
      doubleTapAction: 'zoom',
      bgClickAction: 'close',
      bgOpacity: 1,
      padding: { top: 20, bottom: 20, left: 20, right: 20 },
    });

    // Parse data from image tags
    lightbox.on('uiRegister', function () {
      const pswp = lightbox.pswp;

      // Add class after zoom animation to handle border radius
      // We check if pswp exists (it should inside uiRegister, but safe-check doesn't hurt)
      if (pswp) {
        pswp.on('openingAnimationEnd', () => {
          pswp.element.classList.add('pswp--zoomed-in');
        });
        pswp.on('close', () => {
          pswp.element.classList.remove('pswp--zoomed-in');
        });
      }

      lightbox.pswp.ui.registerElement({
        name: 'custom-caption',
        order: 9,
        isButton: false,
        appendTo: 'root',
        html: 'Caption text',
        onInit: (el, pswp) => {
          pswp.on('change', () => {
            const currSlideElement = pswp.currSlide.data.element;
            let captionText = '';
            if (currSlideElement) {
              captionText = currSlideElement.getAttribute('alt') || '';
            }
            el.innerHTML = captionText ? `<div class="pswp-caption-content">${captionText}</div>` : '';
          });
        },
      });
    });

    // Handle opening via validation of data attributes
    lightbox.addFilter('domItemData', (itemData, element) => {
      if (!element) {
        return itemData;
      }

      // Exclude logo images (in .content-logo container)
      if (element.closest('.content-logo')) {
        return null;
      }

      // Only include images with proper data attributes or valid src
      const src = element.getAttribute('data-pswp-src') || element.src;

      // Skip SVGs and GIFs
      if (src && (src.toLowerCase().includes('.svg') || src.toLowerCase().includes('.gif'))) {
        return null;
      }

      itemData.src = src;
      itemData.w = Number(element.getAttribute('data-pswp-width')) || element.naturalWidth || 1000;
      itemData.h = Number(element.getAttribute('data-pswp-height')) || element.naturalHeight || 1000;
      itemData.msrc = element.src;

      return itemData;
    });

    lightbox.init();
  });
</script>
